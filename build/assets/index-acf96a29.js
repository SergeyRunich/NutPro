import{r as u,a as C,aa as t,j as e,a8 as b,c as a,a4 as L,a5 as W,B as v,be as _,cg as Y,a3 as M,bF as w}from"./index-c20b5e8e.js";import{P as D}from"./progress-7ba6c5df.js";import"./PickerPanel-72c5d64a.js";/* empty css              */import{R as G,C as K}from"./row-58ed805b.js";import{D as z}from"./index-2f7554ca.js";import{g as F,r as q}from"./kitchen-60ac824b.js";import"./index-8e340a60.js";const{Option:p}=W,{RangePicker:J}=z;function Q({startErpRegeneration:d,regenerationData:m,visible:x,onCancel:o}){const[y,R]=u.useState(0),[N,f]=u.useState("all"),[g,c]=u.useState([]),[h,S]=u.useState(0),[O,E]=u.useState(0),[B,P]=u.useState(!1),j=C(),{formatMessage:l}=j;t.updateLocale("en",{week:{dow:1}});const r=i=>t(i).utc().set("hour",0).set("minute",0).set("second",0).set("millisecond",0).unix(),T=u.useCallback(i=>{const s=t().isoWeekday(),n={1:0,2:0};return Number(i)===0?[2,5,7].indexOf(s)!==-1?(n[1]=r(t().add(3,"days")),n[2]=r(t().add(4,"days"))):[1,3,6].indexOf(s)!==-1?(n[1]=r(t().add(2,"days")),n[2]=r(t().add(3,"days"))):[4].indexOf(s)!==-1?(n[1]=r(t().add(4,"days")),n[2]=r(t().add(5,"days"))):console.log("Error period 0"):Number(i)===1?[5,6,7].indexOf(s)!==-1?(n[1]=r(t().add(3-[5,6,7].indexOf(s),"days")),n[2]=r(t().add(4-[5,6,7].indexOf(s),"days"))):[1,2].indexOf(s)!==-1?(n[1]=r(t().add(2-[1,2].indexOf(s),"days")),n[2]=r(t().add(3-[1,2].indexOf(s),"days"))):[3,4].indexOf(s)!==-1?(n[1]=r(t().add(2-[3,4].indexOf(s),"days")),n[2]=r(t().add(3-[3,4].indexOf(s),"days"))):console.log("Error period 1"):Number(i)===2?[5,6,7].indexOf(s)!==-1?(n[1]=r(t().add(5-[5,6,7].indexOf(s),"days")),n[2]=r(t().add(6-[5,6,7].indexOf(s),"days"))):[1,2].indexOf(s)!==-1?(n[1]=r(t().add(4-[1,2].indexOf(s),"days")),n[2]=r(t().add(5-[1,2].indexOf(s),"days"))):[3,4].indexOf(s)!==-1?(n[1]=r(t().add(5-[3,4].indexOf(s),"days")),n[2]=r(t().add(6-[3,4].indexOf(s),"days"))):console.log("Error period 2"):console.log("Error: Invalid period number (code)"),n},[]),k=u.useCallback(i=>{if(R(i.key),i.key!==3){const s=T(i.key);S(s[1]),E(s[2])}},[T]);u.useEffect(()=>{k({key:0}),F().then(async i=>{const s=await i.json();c(s)})},[k]);const I=async i=>{const s=[i[0].unix(),i[1].unix()];S(s[0]),E(s[1])},V=async i=>{f(i.key)},A=async()=>{(await d(N,y,{start:h,end:O})).status===200&&(P(!0),H())},H=()=>{setInterval(()=>{m.status||P(!1)},3e4)};return e(b,{roles:["root","admin"],users:["Vitaly"],children:a(L,{open:x,title:l({id:"RegenerationWidget.ERPRegeneration"}),okText:l({id:"RegenerationWidget.OK"}),okButtonProps:{hidden:!0},cancelButtonProps:{hidden:!0},cancelText:l({id:"RegenerationWidget.Close"}),onCancel:o,onOk:o,children:[m.status&&a("div",{className:"col-xl-12",children:[e("h4",{children:l({id:"RegenerationWidget.REGENERATIONINPROGRESS"})}),e(D,{percent:m.progress.percent}),e("center",{children:a("p",{children:[m.progress.current," / ",m.progress.total]})}),e("center",{children:a("p",{children:[l({id:"RegenerationWidget.StartTime"})," ",t.unix(m.timestamp).format("DD.MM.YYYY HH:mm")," (",t.unix(m.timestamp).fromNow(),")"]})}),e("hr",{})]}),!m.status&&a("div",{className:"col-xl-12",children:[e("center",{children:a("p",{children:[l({id:"RegenerationWidget.LastRegenerationSPACE"})," ",t.unix(m.timestamp).fromNow()]})}),e("hr",{})]}),a(G,{gutter:16,children:[a(K,{span:12,children:[e("h4",{children:l({id:"RegenerationWidget.Kitchen"})}),e("div",{style:{marginTop:"15px",marginBottom:"15px"},children:a(W,{labelInValue:!0,style:{width:"100%"},onChange:V,value:{key:N},placeholder:l({id:"RegenerationWidget.Select"}),children:[e(p,{value:"all",children:l({id:"RegenerationWidget.All"})},"all"),g.map(i=>e(p,{value:i.id,children:i.name},i.id))]})})]}),a(K,{span:12,children:[e("h4",{children:l({id:"RegenerationWidget.Range"})}),e("div",{style:{marginTop:"15px"},children:a(W,{labelInValue:!0,defaultValue:{key:0},style:{width:"100%"},onChange:k,children:[e(p,{value:0,children:l({id:"RegenerationWidget.Default"})}),e(p,{value:1,children:l({id:"RegenerationWidget.FinalOrder"})}),e(p,{value:2,children:l({id:"RegenerationWidget.Preorder"})}),e(p,{value:3,children:l({id:"RegenerationWidget.CustomRange"})})]})}),y===3&&e("div",{style:{marginTop:"15px",marginBottom:"5px"},children:e(J,{ranges:{"Previous Month":[t().subtract(1,"month").startOf("month"),t().subtract(1,"month").endOf("month")],"This Month":[t().startOf("month"),t().endOf("month")]},defaultValue:[t.unix(h),t.unix(O)],format:"DD.MM.YYYY",onChange:I})})]})]}),e("p",{style:{fontSize:"16px"},children:a("center",{children:[t.unix(h).format("DD.MM.YYYY")," -"," ",y===0?"âˆž":t.unix(O).format("DD.MM.YYYY")]})}),e(v,{disabled:m.status||B||h-t().unix()<=84600,type:"primary",onClick:A,style:{width:"100%"},children:l({id:"RegenerationWidget.StartERPRegeneration"})})]})})}t.updateLocale("en",{week:{dow:1}});function U(){const d=C(),[m,x]=u.useState(!1),[o,y]=u.useState({timestamp:0,status:!1,progress:{current:0,total:0,percent:0}}),R=u.useCallback(()=>{let f=null;Y().then(async g=>{if(g.status===200){const c=await g.json();o.status&&!c.result.status&&M.success({message:d.formatMessage({id:"Main.Done"}),description:d.formatMessage({id:"Main.RegenerationIsCompleted"}),duration:0});const h={timestamp:c.result.startTimestamp,status:c.result.status,progress:{current:c.result.progress.current,total:c.result.progress.total,percent:Math.round(c.result.progress.current/c.result.progress.total*100)}};y(h),clearTimeout(f),f=setTimeout(R,c.result.status?5*1e3:30*1e3)}else M.error({message:d.formatMessage({id:"window.error"}),description:g.statusText})})},[o.status,d]);u.useEffect(()=>{R()},[R]);const N=async(f="all",g=0,c={start:0,end:0})=>{const h=await q({kitchen:f,period:g,dates:{start:c.start,end:c.end}});return h.status===200?(setTimeout(()=>Y(),7800),M.success({message:d.formatMessage({id:"window.success"}),description:d.formatMessage({id:"KitchenWidget.ERPKitchenRegenerationSuccessfullyStarted!"})}),x(!1)):M.error({message:d.formatMessage({id:"window.error"}),description:h.statusText}),h};return a("div",{className:"row",children:[e("div",{className:"col-lg-9",children:a("div",{className:"card card--fullHeight",children:[e("div",{className:"card-header",children:e("div",{className:"utils__title utils__title--flat",children:e("strong",{className:"text-uppercase font-size-16",children:d.formatMessage({id:"Main.RegenerationStatus"})})})}),a("div",{className:"card-body",children:[o.status&&e("div",{className:"row",children:a("div",{className:"col-xl-12",children:[e("h3",{children:d.formatMessage({id:"KitchenWidget.REGENERATIONINPROGRESS!!!"})}),e(D,{percent:o.progress.percent}),e("center",{children:a("p",{children:[o.progress.current," / ",o.progress.total]})}),e("center",{children:a("p",{children:[d.formatMessage({id:"KitchenWidget.StartTime"})," ",t.unix(o.timestamp).format("DD.MM.YYYY HH:mm")," (",t.unix(o.timestamp).fromNow(),")"]})}),e("hr",{})]})}),!o.status&&e("div",{className:"row",children:a("div",{className:"col-xl-12",children:[e("center",{children:a("p",{children:[d.formatMessage({id:"KitchenWidget.LastRegeneration"})," ",o.timestamp?t.unix(o.timestamp).fromNow():""]})}),e("hr",{})]})})]})]})}),e("div",{className:"col-lg-3",children:e("div",{className:"card card--fullHeight",children:e("div",{className:"card-body",children:e("div",{className:"row",children:a("div",{className:"col-xl-12",children:[a(b,{roles:["root","admin"],users:["Vitaly"],children:[e("div",{className:"d-flex flex-column justify-content-center",style:{marginBottom:"10px"},children:e(v,{disabled:o.status,type:"primary",onClick:()=>x(!0),children:d.formatMessage({id:"KitchenWidget.ERPRegeneration"})})}),e(w,{to:"/dashboard/kitchen/",children:e("div",{className:"d-flex flex-column justify-content-center",style:{marginBottom:"10px"},children:e(v,{type:"default",children:d.formatMessage({id:"KitchenWidget.KitchenReport"})})})}),e(w,{to:"/users/test/kcal",children:e("div",{className:"d-flex flex-column justify-content-center",style:{marginBottom:"10px"},children:e(v,{type:"default",children:d.formatMessage({id:"KitchenWidget.CustomersKcalTest"})})})}),e(Q,{visible:m,onCancel:()=>x(!1),regenerationData:o,startErpRegeneration:N})]}),e(b,{roles:["root","admin","salesDirector","sales","finance"],children:e("div",{className:"h-15 d-flex flex-column justify-content-center",style:{marginBottom:"10px"},children:e(w,{target:"_blank",to:"/dashboard/production-buffer",children:e(v,{style:{width:"100%"},type:"primary",children:d.formatMessage({id:"KitchenWidget.ProductionBuffer"})})})})})]})})})})})]})}const ne=_(U);export{ne as default};
